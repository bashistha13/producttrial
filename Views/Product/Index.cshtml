@model List<trial.Models.Product>
@{ ViewData["Title"] = "Products"; }

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap4.min.css" />
<link rel="stylesheet" href="https://unpkg.com/dropzone@5/dist/min/dropzone.min.css" />

<h2>Products</h2>

@if (TempData["Success"] != null) { <div class="alert alert-success">@TempData["Success"]</div> }
@if (TempData["Error"] != null) { <div class="alert alert-danger">@TempData["Error"]</div> }

<button onclick="openModal(0)" class="btn btn-success mb-3">Add New Product</button>

<table id="productsTable" class="table table-bordered table-striped">
    <thead>
        <tr>
            <th>Image</th>
            <th>Name</th>
            <th>Price</th>
            <th>Stock</th>
            <th>Category</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var p in Model)
        {
            <tr>
                <td>
                    @if (!string.IsNullOrEmpty(p.ImagePath)) { <img src="@p.ImagePath" style="width:50px;height:50px;object-fit:cover" /> }
                    else { <span>No Image</span> }
                </td>
                <td>@p.ProductName</td>
                <td>@p.Price</td>
                <td>@p.StockQuantity</td>
                <td>@p.CategoryName</td>
                <td>
                    <button onclick="openModal(@p.ProductId)" class="btn btn-primary btn-sm">Edit</button>
                    
                    <form asp-action="Delete" asp-route-id="@p.ProductId" method="post" style="display:inline" onsubmit="return confirm('Delete permanently?');">
                        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                    </form>
                </td>
            </tr>
        }
    </tbody>
</table>

<div class="modal fade" id="productModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add Product</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="$('#productModal').modal('hide')">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="productForm" class="dropzone" enctype="multipart/form-data">
                    <input type="hidden" id="ProductId" name="ProductId" value="0" />
                    <input type="hidden" id="ImagePath" name="ImagePath" /> 

                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="ProductName" name="ProductName" class="form-control" required />
                    </div>
                    <div class="form-group">
                        <label>Price</label>
                        <input type="number" id="Price" name="Price" class="form-control" required />
                    </div>
                    <div class="form-group">
                        <label>Stock</label>
                        <input type="number" id="StockQuantity" name="StockQuantity" class="form-control" required />
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="CategoryId" name="CategoryId" class="form-control" required>
                            <option value="">-- Select Category --</option>
                            @if (ViewBag.Categories != null)
                            {
                                foreach (var cat in ViewBag.Categories)
                                {
                                    <option value="@cat.CategoryId">@cat.CategoryName</option>
                                }
                            }
                        </select>
                    </div>
                    
                    <div class="dz-message">Click or drop image here</div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="$('#productModal').modal('hide')">Close</button>
                <button type="button" id="btnSave" class="btn btn-primary">Save changes</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://unpkg.com/dropzone@5/dist/min/dropzone.min.js"></script>

    <script>
        // 1. Initialize DataTable
        $(document).ready(function() {
            $('#productsTable').DataTable();
        });

        // 2. Configure Dropzone
        Dropzone.autoDiscover = false;
        var myDropzone = new Dropzone("#productForm", {
            url: "/Product/AddOrEdit", // URL to send files
            autoProcessQueue: false,   // Wait for Save button
            uploadMultiple: false,
            maxFiles: 1,
            addRemoveLinks: true,
            init: function() {
                var dz = this;
                
                // When "Save" is clicked
                document.getElementById("btnSave").addEventListener("click", function (e) {
                    e.preventDefault();
                    
                    // If file exists, process queue (sends Form + File)
                    if (dz.getQueuedFiles().length > 0) {
                        dz.processQueue();
                    } else {
                        // If no file, manually send form data using Fetch
                        var formData = new FormData(document.querySelector("#productForm"));
                        fetch('/Product/AddOrEdit', { method: 'POST', body: formData })
                            .then(r => r.json())
                            .then(data => {
                                if (data.success) location.reload();
                                else alert(data.message);
                            });
                    }
                });

                // On Success from Dropzone
                this.on("success", function (file, response) {
                    if (response.success) location.reload();
                    else alert(response.message);
                });
                
                // Append form fields to Dropzone request
                this.on("sending", function(file, xhr, formData) {
                    formData.append("ProductId", $('#ProductId').val());
                    formData.append("ProductName", $('#ProductName').val());
                    formData.append("Price", $('#Price').val());
                    formData.append("StockQuantity", $('#StockQuantity').val());
                    formData.append("CategoryId", $('#CategoryId').val());
                    formData.append("ImagePath", $('#ImagePath').val());
                });
            }
        });

        // 3. Open Modal Logic (Add or Edit)
        function openModal(id) {
            // Reset Form & Dropzone
            $('#productForm')[0].reset();
            myDropzone.removeAllFiles(true);
            
            if (id === 0) {
                // ADD MODE
                $('#modalTitle').text("Add Product");
                $('#ProductId').val(0);
                $('#ImagePath').val('');
                $('#productModal').modal('show');
            } else {
                // EDIT MODE - Fetch data first
                fetch('/Product/GetProduct/' + id)
                    .then(response => response.json())
                    .then(data => {
                        $('#modalTitle').text("Edit Product");
                        $('#ProductId').val(data.productId);
                        $('#ProductName').val(data.productName);
                        $('#Price').val(data.price);
                        $('#StockQuantity').val(data.stockQuantity);
                        $('#CategoryId').val(data.categoryId);
                        $('#ImagePath').val(data.imagePath); // Keep old path
                        
                        $('#productModal').modal('show');
                    });
            }
        }
    </script>
}