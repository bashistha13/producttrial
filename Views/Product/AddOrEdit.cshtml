@model trial.Models.Product
@{ ViewData["Title"] = ViewBag.Title; }

<link rel="stylesheet" href="https://unpkg.com/dropzone@5/dist/min/dropzone.min.css" />

<h2>@ViewBag.Title</h2>

<form asp-action="AddOrEdit" class="dropzone" id="my-dropzone" enctype="multipart/form-data">
    <input type="hidden" asp-for="ProductId" />
    <input type="hidden" asp-for="ImagePath" />

    <div class="form-group">
        <label>Product Name</label>
        <input asp-for="ProductName" class="form-control" required />
    </div>
    <div class="form-group">
        <label>Price</label>
        <input asp-for="Price" type="number" class="form-control" required />
    </div>
    <div class="form-group">
        <label>Stock</label>
        <input asp-for="StockQuantity" type="number" class="form-control" required />
    </div>
    <div class="form-group">
        <label>Category</label>
        <select asp-for="CategoryId" class="form-control" asp-items="@(new SelectList(ViewBag.Categories, "CategoryId", "CategoryName"))" required>
            <option value="">-- Select Category --</option>
        </select>
    </div>
</form>

<button id="submit-all" class="btn btn-success mt-3">Save Product</button>
<a asp-action="Index" class="btn btn-secondary mt-3">Back</a>

@section Scripts {
    <script src="https://unpkg.com/dropzone@5/dist/min/dropzone.min.js"></script>
    <script>
        Dropzone.autoDiscover = false;
        var myDropzone = new Dropzone("#my-dropzone", {
            autoProcessQueue: false,
            uploadMultiple: false,
            maxFiles: 1,
            addRemoveLinks: true,
            init: function() {
                var dz = this;
                document.getElementById("submit-all").addEventListener("click", function(e) {
                    e.preventDefault();
                    if (dz.getQueuedFiles().length > 0) {
                        dz.processQueue(); // Sends Form + File
                    } else {
                        // Sends Form Only (Edit mode without new image)
                        var formData = new FormData(document.querySelector("#my-dropzone"));
                        fetch('/Product/AddOrEdit', { method: 'POST', body: formData })
                        .then(r => r.json()).then(data => {
                            if(data.success) window.location.href = "/Product/Index";
                        });
                    }
                });
                this.on("success", function(file, response) {
                    if (response.success) window.location.href = "/Product/Index";
                });
            }
        });
    </script>
}